# ‚öôÔ∏è Backend Configuration Guide

<div align="center">

![Laravel](https://img.shields.io/badge/Laravel-12-FF2D20?style=flat-square&logo=laravel&logoColor=white)
![PHP](https://img.shields.io/badge/PHP-8.2+-777BB4?style=flat-square&logo=php&logoColor=white)

**Panduan Lengkap Konfigurasi Backend Bookera**

</div>

---

## üìã Daftar Isi

- [Prerequisites](#-prerequisites)
- [Instalasi](#-instalasi)
- [Environment Variables](#-environment-variables)
- [Database Setup](#-database-setup)
- [Storage Configuration](#-storage-configuration)
- [Real-time Setup](#-real-time-setup)
- [Development](#-development)
- [Build & Deployment](#-build--deployment)
- [Troubleshooting](#-troubleshooting)

---

## üîß Prerequisites

Sebelum memulai, pastikan sistem Anda telah memenuhi requirement berikut:

### System Requirements

| Software | Versi Minimum | Rekomendasi | Cara Install |
|----------|---------------|-------------|--------------|
| **PHP** | 8.2.0 | 8.3.x | [php.net](https://php.net) |
| **Composer** | 2.5.x | Latest | [getcomposer.org](https://getcomposer.org) |
| **MySQL** | 8.0.x | 8.0.x atau MariaDB 10.x | [mysql.com](https://mysql.com) |
| **Node.js** | 18.x | 20.x | [nodejs.org](https://nodejs.org) |
| **Git** | 2.x | Latest | [git-scm.com](https://git-scm.com) |

### PHP Extensions Required

Pastikan PHP extensions berikut terinstall:

```bash
# Cek extensions
php -m

# Required extensions:
- OpenSSL
- PDO
- Mbstring
- Tokenizer
- XML
- Ctype
- JSON
- BCMath
- Fileinfo
- GD atau Imagick (untuk image processing)
```

#### Install PHP Extensions (Ubuntu/Debian)

```bash
sudo apt-get install php8.2-cli php8.2-common php8.2-mysql php8.2-xml php8.2-mbstring php8.2-curl php8.2-gd php8.2-zip php8.2-bcmath
```

#### Install PHP Extensions (Windows)

- Download PHP dari [windows.php.net](https://windows.php.net)
- Edit `php.ini`, uncomment extensions yang dibutuhkan
- Restart web server

### Cek Versi

```bash
# Cek versi PHP
php --version

# Cek versi Composer
composer --version

# Cek versi MySQL
mysql --version

# Cek versi Node (untuk Vite)
node --version
```

---

## üì¶ Instalasi

### 1. Clone Repository

```bash
# Clone dari Git
git clone https://github.com/yourusername/bookera.git

# Masuk ke direktori backend
cd bookera/bookera-api
```

### 2. Install Dependencies

```bash
# Install PHP dependencies via Composer
composer install

# Install Node.js dependencies (untuk Vite)
npm install
```

**Note:** Jika production, gunakan `composer install --no-dev` untuk skip dev dependencies.

### 3. Setup Environment File

```bash
# Copy .env.example ke .env
cp .env.example .env

# Windows:
copy .env.example .env
```

### 4. Generate Application Key

```bash
# Generate APP_KEY
php artisan key:generate
```

**Important:** `APP_KEY` digunakan untuk enkripsi. Jangan share key ini!

### 5. Setup Database

```bash
# Jalankan migrations
php artisan migrate

# Seed database dengan data dummy (opsional)
php artisan db:seed

# Atau migrate + seed sekaligus
php artisan migrate --seed
```

### 6. Create Storage Link

```bash
# Link storage folder ke public
php artisan storage:link
```

Ini membuat symbolic link `public/storage` ‚Üí `storage/app/public` untuk akses file upload.

### 7. Setup Queue Tables

```bash
# Jika menggunakan database queue
php artisan queue:table
php artisan migrate
```

---

## üîê Environment Variables

Environment variables berisi konfigurasi aplikasi. File `.env` **tidak akan** di-commit ke repository untuk keamanan.

### File `.env` Lengkap

```bash
# ===========================================
# APPLICATION CONFIGURATION
# ===========================================
APP_NAME=Bookera
APP_ENV=local                      # local, production, staging
APP_KEY=                           # Auto-generated by php artisan key:generate
APP_DEBUG=true                     # MUST be false in production
APP_URL=http://localhost:8000

APP_LOCALE=id                      # Default: en (English), id (Indonesia)
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

APP_MAINTENANCE_DRIVER=file
BCRYPT_ROUNDS=12                   # Password hashing rounds

LOG_CHANNEL=stack                  # single, daily, slack, stderr
LOG_STACK=single
LOG_LEVEL=debug                    # debug, info, notice, warning, error


# ===========================================
# DATABASE CONFIGURATION
# ===========================================
# SQLite (Development - Simple)
DB_CONNECTION=sqlite

# MySQL (Production - Recommended)
# DB_CONNECTION=mysql
# DB_HOST=127.0.0.1
# DB_PORT=3306
# DB_DATABASE=bookera
# DB_USERNAME=root
# DB_PASSWORD=


# ===========================================
# SESSION CONFIGURATION
# ===========================================
SESSION_DRIVER=database            # file, cookie, database, redis
SESSION_LIFETIME=120               # Minutes
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null


# ===========================================
# BROADCASTING (Real-time WebSocket)
# ===========================================
BROADCAST_CONNECTION=reverb        # log, pusher, reverb, redis

# LARAVEL REVERB (Self-hosted WebSocket)
REVERB_APP_ID=your-app-id
REVERB_APP_KEY=your-app-key
REVERB_APP_SECRET=your-app-secret
REVERB_HOST=127.0.0.1
REVERB_PORT=8080
REVERB_SCHEME=http

# Untuk frontend connection
REVERB_PUBLIC_HOST=localhost
REVERB_PUBLIC_PORT=8080
REVERB_PUBLIC_SCHEME=http

# PUSHER (Alternative - Commercial)
# PUSHER_APP_ID=
# PUSHER_APP_KEY=
# PUSHER_APP_SECRET=
# PUSHER_APP_CLUSTER=mt1


# ===========================================
# CACHE CONFIGURATION
# ===========================================
CACHE_STORE=database               # file, database, redis, memcached
CACHE_PREFIX=bookera_cache


# ===========================================
# QUEUE CONFIGURATION
# ===========================================
QUEUE_CONNECTION=database          # sync, database, redis, sqs


# ===========================================
# FILESYSTEM CONFIGURATION
# ===========================================
FILESYSTEM_DISK=local              # local, public, s3
# Untuk production bisa gunakan S3/DigitalOcean Spaces


# ===========================================
# MAIL CONFIGURATION
# ===========================================
MAIL_MAILER=smtp                   # smtp, sendmail, mailgun, ses
MAIL_HOST=smtp.mailtrap.io         # Development
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=tls                # tls, ssl
MAIL_FROM_ADDRESS="noreply@bookera.com"
MAIL_FROM_NAME="${APP_NAME}"

# Mailgun (Production option)
# MAILGUN_DOMAIN=
# MAILGUN_SECRET=

# AWS SES (Production option)
# AWS_ACCESS_KEY_ID=
# AWS_SECRET_ACCESS_KEY=
# AWS_DEFAULT_REGION=us-east-1


# ===========================================
# REDIS CONFIGURATION (Optional)
# ===========================================
REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379


# ===========================================
# AWS S3 CONFIGURATION (Optional)
# ===========================================
# For file storage in production
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false


# ===========================================
# CORS CONFIGURATION
# ===========================================
# Frontend URL (untuk CORS)
FRONTEND_URL=http://localhost:3000


# ===========================================
# SANCTUM CONFIGURATION
# ===========================================
SANCTUM_STATEFUL_DOMAINS=localhost:3000
```

---

## üìä Database Setup

### Option 1: SQLite (Recommended untuk Development)

**Advantages:**
- ‚úÖ No setup required
- ‚úÖ Perfect untuk development
- ‚úÖ File-based, portable

**Setup:**

```bash
# 1. Set DB_CONNECTION di .env
DB_CONNECTION=sqlite

# 2. Create database file
touch database/database.sqlite

# Windows:
type nul > database\database.sqlite

# 3. Run migrations
php artisan migrate --seed
```

---

### Option 2: MySQL/MariaDB (Recommended untuk Production)

**Advantages:**
- ‚úÖ Production-ready
- ‚úÖ Better performance untuk banyak concurrent users
- ‚úÖ Advanced features

**Setup:**

#### 1. Create Database

```sql
-- Login ke MySQL
mysql -u root -p

-- Create database
CREATE DATABASE bookera CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Create user (optional)
CREATE USER 'bookera_user'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON bookera.* TO 'bookera_user'@'localhost';
FLUSH PRIVILEGES;

-- Exit
EXIT;
```

#### 2. Configure `.env`

```bash
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=bookera
DB_USERNAME=bookera_user
DB_PASSWORD=password
```

#### 3. Run Migrations

```bash
php artisan migrate --seed
```

---

### Database Migrations

Migrations adalah version control untuk database schema.

```bash
# Jalankan migrations
php artisan migrate

# Rollback last migration batch
php artisan migrate:rollback

# Rollback all migrations
php artisan migrate:reset

# Drop all tables dan re-run migrations
php artisan migrate:fresh

# Fresh migration + seed
php artisan migrate:fresh --seed

# Check migration status
php artisan migrate:status
```

---

### Database Seeders

Seeders mengisi database dengan data dummy untuk development/testing.

```bash
# Run all seeders
php artisan db:seed

# Run specific seeder
php artisan db:seed --class=UserSeeder

# Seed dengan migrations
php artisan migrate --seed
```

**Available Seeders:**
- `UserSeeder` - Admin, Officer, Member users
- `CategorySeeder` - Book categories
- `BookSeeder` - Sample books
- `LoanSeeder` - Sample loan transactions

---

## üíæ Storage Configuration

Laravel menggunakan filesystem abstraction untuk file management.

### Storage Disks

Konfigurasi ada di `config/filesystems.php`:

```php
'disks' => [
    'local' => [...],      // storage/app
    'public' => [...],     // storage/app/public
    's3' => [...],         // AWS S3
]
```

### Storage Directories

```
storage/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ public/              # Public files (photos, uploads)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatars/        # User avatars
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-covers/    # Book cover images
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ documents/      # Documents
‚îÇ   ‚îî‚îÄ‚îÄ private/            # Private files
‚îú‚îÄ‚îÄ framework/              # Framework files (cache, sessions, views)
‚îú‚îÄ‚îÄ logs/                   # Application logs
‚îî‚îÄ‚îÄ ...
```

### Create Storage Link

```bash
# Create symbolic link public/storage ‚Üí storage/app/public
php artisan storage:link
```

**Why?** Agar file di `storage/app/public` bisa diakses via URL:
- File: `storage/app/public/avatars/user.jpg`
- URL: `http://localhost:8000/storage/avatars/user.jpg`

### File Upload Configuration

#### Max Upload Size

Edit `php.ini`:

```ini
upload_max_filesize = 10M
post_max_size = 10M
max_execution_time = 300
```

Restart web server setelah perubahan.

#### Validation in Code

```php
// app/Http/Requests/BookRequest.php
public function rules()
{
    return [
        'cover' => 'required|image|mimes:jpeg,png,jpg|max:2048', // 2MB
    ];
}
```

---

## üîî Real-time Setup (Laravel Reverb)

Bookera menggunakan **Laravel Reverb** untuk real-time notifications via WebSocket.

### What is Laravel Reverb?

- Self-hosted WebSocket server
- Alternative gratis untuk Pusher
- Built-in dengan Laravel
- Perfect untuk real-time features

### Setup Steps

#### 1. Install Reverb (Already installed)

```bash
composer require laravel/reverb
```

#### 2. Configure `.env`

```bash
BROADCAST_CONNECTION=reverb

REVERB_APP_ID=my-app-id
REVERB_APP_KEY=my-app-key
REVERB_APP_SECRET=my-app-secret
REVERB_HOST=127.0.0.1
REVERB_PORT=8080
REVERB_SCHEME=http

# Public credentials untuk frontend
REVERB_PUBLIC_HOST=localhost
REVERB_PUBLIC_PORT=8080
REVERB_PUBLIC_SCHEME=http
```

**Generate Credentials:**

```bash
php artisan reverb:install
```

#### 3. Start Reverb Server

```bash
php artisan reverb:start
```

Server akan berjalan di `ws://localhost:8080`

#### 4. Configure Frontend

Di frontend `.env.local`:

```bash
NEXT_PUBLIC_PUSHER_APP_KEY=my-app-key
NEXT_PUBLIC_WEBSOCKET_HOST=localhost
NEXT_PUBLIC_WEBSOCKET_PORT=8080
NEXT_PUBLIC_WEBSOCKET_SCHEME=http
```

#### 5. Test Real-time

```bash
# Terminal 1: Start Laravel
php artisan serve

# Terminal 2: Start Reverb
php artisan reverb:start

# Terminal 3: Start Queue Worker
php artisan queue:work

# Terminal 4: Start Frontend
cd ../bookera-web
npm run dev
```

### Broadcasting Events

Events yang di-broadcast untuk real-time updates:

```
app/Events/
‚îú‚îÄ‚îÄ LoanRequested.php        # Peminjaman diminta
‚îú‚îÄ‚îÄ LoanApproved.php         # Peminjaman disetujui
‚îú‚îÄ‚îÄ LoanRejected.php         # Peminjaman ditolak
‚îú‚îÄ‚îÄ ReturnRequested.php      # Pengembalian diminta
‚îú‚îÄ‚îÄ ReturnApproved.php       # Pengembalian disetujui
‚îú‚îÄ‚îÄ FineCreated.php          # Denda dibuat
‚îî‚îÄ‚îÄ LostBookReported.php     # Buku hilang dilaporkan
```

---

## üöÄ Development

### Running Development Server

#### Option 1: Artisan Serve (Simple)

```bash
php artisan serve
```

Server berjalan di **http://localhost:8000**

#### Option 2: Dengan Queue & Reverb

```bash
# Terminal 1: Laravel Server
php artisan serve

# Terminal 2: Queue Worker
php artisan queue:work

# Terminal 3: Reverb WebSocket
php artisan reverb:start

# Terminal 4: Logs (optional)
php artisan pail
```

#### Option 3: Script Composer (All-in-one)

```bash
composer dev
```

Menjalankan semua service sekaligus (server, queue, reverb, logs).

### Development Workflow

1. **Edit Code** - Make changes
2. **Test Manually** - Browser testing
3. **Run Tests** - `php artisan test`
4. **Check Logs** - `tail -f storage/logs/laravel.log`
5. **Code Format** - `./vendor/bin/pint`

### Available Artisan Commands

```bash
# List all commands
php artisan list

# Make commands (generators)
php artisan make:controller UserController
php artisan make:model Book -m              # dengan migration
php artisan make:migration create_books_table
php artisan make:seeder BookSeeder
php artisan make:request BookRequest
php artisan make:resource BookResource
php artisan make:event LoanApproved
php artisan make:listener SendLoanNotification

# Database commands
php artisan migrate                          # Run migrations
php artisan db:seed                          # Run seeders
php artisan migrate:fresh --seed             # Fresh + seed

# Cache commands
php artisan cache:clear                      # Clear application cache
php artisan config:clear                     # Clear config cache
php artisan route:clear                      # Clear route cache
php artisan view:clear                       # Clear view cache

# Queue commands
php artisan queue:work                       # Start queue worker
php artisan queue:restart                    # Restart queue workers
php artisan queue:failed                     # List failed jobs
php artisan queue:retry all                  # Retry failed jobs

# Other useful commands
php artisan route:list                       # List all routes
php artisan tinker                           # REPL console
php artisan test                             # Run tests
```

### Testing

```bash
# Run all tests
php artisan test

# Run specific test
php artisan test --filter=UserTest

# Run with coverage
php artisan test --coverage

# Parallel testing (faster)
php artisan test --parallel
```

---

## üèó Build & Deployment

### Pre-deployment Checklist

```bash
# 1. Optimize autoload
composer install --optimize-autoloader --no-dev

# 2. Cache configuration
php artisan config:cache

# 3. Cache routes
php artisan route:cache

# 4. Cache views
php artisan view:cache

# 5. Run migrations
php artisan migrate --force

# 6. Link storage
php artisan storage:link
```

### Environment Configuration (Production)

```bash
APP_ENV=production
APP_DEBUG=false                # IMPORTANT: Must be false!
APP_URL=https://api.bookera.com

DB_CONNECTION=mysql
# ... set production database credentials

MAIL_MAILER=smtp
# ... set production mail credentials

# etc...
```

### Deployment Options

#### 1. Shared Hosting

Biasanya menggunakan cPanel:

1. Upload files via FTP/Git
2. Set document root ke `public/`
3. Set environment variables di cPanel
4. Run composer install via SSH
5. Run migrations

#### 2. VPS/Cloud Server

**Using Apache:**

```apache
<VirtualHost *:80>
    ServerName api.bookera.com
    DocumentRoot /var/www/bookera/public

    <Directory /var/www/bookera/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

**Using Nginx:**

```nginx
server {
    listen 80;
    server_name api.bookera.com;
    root /var/www/bookera/public;

    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

**Process Manager (PM2 untuk Queue & Reverb):**

```bash
# Install PM2
npm install -g pm2

# Start queue worker
pm2 start "php artisan queue:work --tries=3" --name bookera-queue

# Start Reverb
pm2 start "php artisan reverb:start" --name bookera-reverb

# Auto-start on reboot
pm2 startup
pm2 save
```

#### 3. Docker

**Dockerfile example:**

```dockerfile
FROM php:8.2-fpm

# Install dependencies
RUN apt-get update && apt-get install -y \
    git curl libpng-dev libonig-dev libxml2-dev zip unzip

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Set working directory
WORKDIR /var/www

# Copy application
COPY . .

# Install dependencies
RUN composer install --no-dev --optimize-autoloader

# Set permissions
RUN chown -R www-data:www-data /var/www

EXPOSE 9000
CMD ["php-fpm"]
```

---

## üîç Troubleshooting

### Common Issues

#### 1. "Class not found" Error

**Solution:**
```bash
composer dump-autoload
php artisan clear-compiled
php artisan config:clear
```

#### 2. Permission Issues (Storage)

**Error:**
```
The stream or file "storage/logs/laravel.log" could not be opened
```

**Solution (Linux/Mac):**
```bash
sudo chmod -R 775 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache
```

**Solution (Windows):**
- Right-click folder ‚Üí Properties ‚Üí Security
- Give full control ke user IIS/Apache

#### 3. Database Connection Failed

**Error:**
```
SQLSTATE[HY000] [2002] Connection refused
```

**Solution:**
```bash
# Cek MySQL running
sudo service mysql status

# Start MySQL
sudo service mysql start

# Cek credentials di .env
# DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD
```

#### 4. Queue Jobs Not Processing

**Problem:** Jobs masuk queue tapi tidak di-process

**Solution:**
```bash
# Restart queue worker
php artisan queue:restart
php artisan queue:work

# Check failed jobs
php artisan queue:failed

# Retry failed jobs
php artisan queue:retry all
```

#### 5. Reverb Connection Failed

**Error:**
```
WebSocket connection to 'ws://localhost:8080' failed
```

**Solution:**
```bash
# Make sure Reverb is running
php artisan reverb:start

# Check Reverb config in .env
# REVERB_HOST, REVERB_PORT

# Check firewall tidak block port 8080
```

#### 6. Route Not Found (404)

**Problem:** API endpoint returns 404

**Solution:**
```bash
# Clear route cache
php artisan route:clear

# List all routes
php artisan route:list

# Verify route exists
```

#### 7. CORS Issues

**Error:**
```
Access to fetch has been blocked by CORS policy
```

**Solution:**

Edit `config/cors.php`:

```php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => ['http://localhost:3000'], // Frontend URL
    'allowed_headers' => ['*'],
    'supports_credentials' => true,
];
```

#### 8. Upload Fails (File Too Large)

**Error:**
```
The file exceeds your upload_max_filesize ini directive
```

**Solution:**

Edit `php.ini`:
```ini
upload_max_filesize = 10M
post_max_size = 10M
```

Restart web server.

---

## üõ°Ô∏è Security Best Practices

### 1. Environment Variables

```bash
# NEVER commit .env to Git
# Add to .gitignore
.env
.env.backup
```

### 2. Production Settings

```bash
APP_DEBUG=false              # Hide errors from users
APP_ENV=production
```

### 3. Database Security

```bash
# Use strong passwords
# Use separate DB user (not root)
# Grant only necessary privileges
```

### 4. HTTPS in Production

```bash
# Force HTTPS
APP_URL=https://api.bookera.com

# In AppServiceProvider
if (app()->environment('production')) {
    URL::forceScheme('https');
}
```

### 5. Rate Limiting

Laravel has built-in rate limiting in `app/Http/Kernel.php`.

---

## üìö Additional Resources

### Official Documentation

- [Laravel 12 Documentation](https://laravel.com/docs/12.x)
- [Laravel API Resources](https://laravel.com/docs/12.x/eloquent-resources)
- [Laravel Broadcasting](https://laravel.com/docs/12.x/broadcasting)
- [Laravel Reverb](https://laravel.com/docs/12.x/reverb)

### Video Tutorials

- [Laravel From Scratch (Laracasts)](https://laracasts.com/series/laravel-from-scratch)
- [Laravel Daily YouTube](https://www.youtube.com/@LaravelDaily)

### Community

- [Laravel News](https://laravel-news.com)
- [Laracasts Forum](https://laracasts.com/discuss)
- [Laravel Discord](https://discord.gg/laravel)

---

## üìù Next Steps

Setelah selesai konfigurasi, lanjutkan ke:

1. **[Architecture & Packages Guide](./ARCHITECTURE.md)** - Pelajari struktur folder dan package yang digunakan
2. **[Frontend Configuration](../bookera-web/CONFIGURATION.md)** - Setup frontend
3. **[Real-time Notifications Setup](../REALTIME_NOTIFICATIONS_SETUP.md)** - Setup notifikasi real-time

---

<div align="center">

**Butuh bantuan?** Buka issue di [GitHub Repository](https://github.com/yourusername/bookera/issues)

Made with ‚ù§Ô∏è by Nadhif A.W

</div>
